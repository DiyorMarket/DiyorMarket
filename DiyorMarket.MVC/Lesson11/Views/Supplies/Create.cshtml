@model Lesson11.ViewModels.SupplyViewModel
@using System.Collections.Generic

@{
    ViewData["Title"] = "Create";
    Layout = "~/Views/Shared/_DataGridLayout.cshtml";
}

<!-- Navigation link -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/dashboard/index"><i class="fa fa-home" style="color: white"></i></a></li>
        <li class="breadcrumb-item"><a asp-controller="Supplies" asp-action="Index">Supplies List</a></li>
        <li class="breadcrumb-item active" aria-current="page">Create</li>
    </ol>
</nav>

<hr class="align-items-baseline" style="margin-top: 100px" />


<form asp-action="Create">
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
    <div class="d-flex justify-content-start">
        <div class="p-2">
            <label asp-for="Supply.SupplyDate" class="control-label"></label>
            <input asp-for="Supply.SupplyDate" class="form-control" />
            <span asp-validation-for="Supply.SupplyDate" class="text-danger"></span>
        </div>
        <div class="p-0 mr-5">
            <label asp-for="Supply.SupplierId" class="control-label mt-2"></label>
            <select asp-for="Supply.SupplierId" class="form-control border border-dark" asp-items="@ViewBag.Suppliers"></select>
        </div>
    </div>
    <div class="d-flex justify-content-start">
        <div class="p-0 mr-5">
            <label asp-for="SupplyItem.ProductId" class="control-label mt-2"></label>
            <select asp-for="SupplyItem.ProductId" id="supplyItemProductId" class="form-control border border-dark" asp-items="@ViewBag.Products"></select>
        </div>
        <div class="p-2">
            <label asp-for="SupplyItem.Quantity" class="control-label"></label>
            <input asp-for="SupplyItem.Quantity" id="SupplyItem_Quantity" class="form-control" />
            <span asp-validation-for="SupplyItem.Quantity" class="text-danger"></span>
        </div>
        <div class="p-2">
            <label asp-for="SupplyItem.UnitPrice" class="control-label"></label>
            <input asp-for="SupplyItem.UnitPrice" id="SupplyItem_UnitPrice" class="form-control" />
            <span asp-validation-for="SupplyItem.UnitPrice" class="text-danger"></span>
        </div>

    </div>

    <div class="form-group mt-3">
        <button class="btn btn-outline-success mr-auto" type="button" id="btnAddSupplyItem">
            <i class="fa fa-plus"></i> Add
        </button>
    </div>

    <div class="form-group mt-3">
        <a asp-action="Index" class="btn btn-outline-info">
            <i class="fa-solid fa-arrow-left-long"></i>
            Back
        </a>
        <button class="btn btn-outline-success mr-auto">
            <i class="fa fa-plus"></i> Create
        </button>
    </div>
</form>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $("#btnAddSupplyItem").click(function () {
            var supplyItem = {
                ProductId: $("#supplyItemProductId").val(),
                Quantity: parseInt($("#SupplyItem_Quantity").val(), 10),
                UnitPrice: parseFloat($("#SupplyItem_UnitPrice").val())
            };

            $.ajax({
                type: "POST",
                url: "/Supplies/AddSupplyItem",
                data: supplyItem,
                success: function (result) {
                    // Обновление данных в ejs-grid
                    var gridElement = document.getElementById('supplyItems-list');
                    var grid = ej.base.getComponent(gridElement, 'ejs-grid');

                    if (!grid) {
                        console.log("Grid not found. Creating new grid.");

                        // Инициализация EJS Grid
                        grid = new ej.grids.Grid({
                            dataSource: result,
                            columns: [
                                { field: 'ProductId', headerText: 'Product Name', type: 'string' },
                                { field: 'Quantity', headerText: 'Quantity', type: 'number', format: 'C2' },
                                { field: 'UnitPrice', headerText: 'UnitPrice', type: 'string' },
                                // Дополните вашими столбцами
                            ]
                        });

                        grid.appendTo(gridElement);
                    } else {
                        // Если EJS Grid уже существует, обновите данные
                        grid.dataSource = result;
                        grid.refresh();
                    }
                },
                error: function (error) {
                    console.error("Ошибка при добавлении элемента:", error);
                }
            });
        });
    </script>

}
